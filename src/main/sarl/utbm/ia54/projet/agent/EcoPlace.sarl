package utbm.ia54.projet.^agent

import io.sarl.core.Behaviors
import io.sarl.core.DefaultContextInteractions
import io.sarl.core.Initialize
import io.sarl.core.Lifecycle
import io.sarl.util.OpenEventSpace
import io.sarl.util.OpenEventSpaceSpecification
import io.sarl.util.Scopes
import java.util.ArrayList
import java.util.UUID
import utbm.ia54.projet.message.AskSynchroMessage
import utbm.ia54.projet.message.LogMessage
import utbm.ia54.projet.message.SynchroResponse
import utbm.ia54.projet.message.TilePlaced

/**
 * @author Lucas
 *
 */
agent EcoPlace extends EcoAgent {
	uses DefaultContextInteractions, Lifecycle,Behaviors
	
	var space : OpenEventSpace 
	var spaceUUID : UUID
	var tileObj : Integer
	
	on Initialize {
		// Initialize parameters
		pos = occurrence.parameters.get(0) as Integer
		spaceUUID = occurrence.parameters.get(1) as UUID
		
		space = defaultContext.getOrCreateSpaceWithSpec(
			typeof(OpenEventSpaceSpecification),
			spaceUUID
		);
		space.register(asEventListener())
		globalSpace = defaultContext.getOrCreateSpaceWithSpec(
			typeof(OpenEventSpaceSpecification),
			occurrence.parameters.get(3) as UUID
		)
		globalSpace.register(asEventListener)
		for(t as UUID : occurrence.parameters.get(2) as ArrayList<UUID>){
			defaultContext.getOrCreateSpaceWithSpec(
				typeof(OpenEventSpaceSpecification),
				t
			).register(asEventListener())
		}
		
		// Debug
//		println("Place"+pos+" | Id:"+ID+" | Linked:"+idLinked)
			
		// 
		killMe
	}
	
//	on TilePlaced {
//		idLinked = occurrence.id
//		emit(new AskSynchroMessage(ID,pos), Scopes.addresses(globalSpace.getAddress(idLinked)))
//	}
//	
//	on AskSynchroMessage{
//		idLinked = occurrence.id
//		tileObj = occurrence.pos
//		emit(new SynchroResponse(ID,pos),Scopes.addresses(globalSpace.getAddress(idLinked)))
//	}
//	
//	on SynchroResponse{
//		idLinked = occurrence.id
//		tileObj = occurrence.pos
//	}
	
	on LogMessage{
		println("id : " + ID + " | pos : " + pos + " | linkedId : " + idLinked + " | posObjLinked : " + tileObj + "\n")
		killMe
	}
}